Bootstrap: docker
From: ubuntu:20.04

%labels
    Author "Glen Dierickx"
    Version "0.1"
    Description "Apptainer container for the eNano pipeline without conda, pinned dependencies"

%environment
    export PATH=/usr/local/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    export DEBIAN_FRONTEND=noninteractive
    START_DIR=$(pwd)

    # Prerequisites for LLVM repo to get clang-17
    apt-get update && apt-get install -y wget gnupg lsb-release ca-certificates && rm -rf /var/lib/apt/lists/*

    # Install clang-17 via llvm.sh
    wget https://apt.llvm.org/llvm.sh -O /tmp/llvm.sh
    chmod +x /tmp/llvm.sh
    /tmp/llvm.sh 17

    # Install other required system dependencies
    apt-get update && apt-get install -y \
        git build-essential curl gzip \
        python3 python3-pip python3-setuptools python3-wheel \
        cmake autoconf automake libtool pkg-config make unzip \
        && rm -rf /var/lib/apt/lists/*

    # Upgrade pip
    python3 -m pip install --upgrade pip

    # Install Python dependencies
    # cutadapt≥2.8, porechop=0.2.4, pandas any pinned version
    python3 -m pip install "cutadapt>=2.8" "porechop==0.2.4" pandas

    # Install chopper≥0.9 directly from the released binary
    cd /opt
    wget https://github.com/wdecoster/chopper/releases/download/v0.9.0/chopper-linux.zip
    unzip -j chopper-linux.zip chopper -d /usr/local/bin/
    chmod +x /usr/local/bin/chopper

    # Install vsearch≥2.21 from source (example v2.29.1)
    cd /opt
    wget https://github.com/torognes/vsearch/archive/v2.29.1.tar.gz
    tar xzf v2.29.1.tar.gz
    cd vsearch-2.29.1
    ./autogen.sh
    ./configure CFLAGS="-O3" CXXFLAGS="-O3"
    make ARFLAGS="cr"
    make install

    # Install mumu (v1.0 tag) with g++
    cd /opt
    git clone https://github.com/frederic-mahe/mumu.git
    cd mumu
    git checkout v1.0
    make CXX=g++
    make install prefix=/usr/local

    # Return to the starting directory
    cd $START_DIR

    # Fetch eNano.sh
    wget -O /usr/local/bin/eNano 'https://raw.githubusercontent.com/MycoMatics/eNano/Apptainer_minimal/eNano.sh'
    chmod +x /usr/local/bin/eNano

%runscript
    exec eNano "$@"
