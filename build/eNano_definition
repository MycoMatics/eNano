Bootstrap: docker
From: ubuntu:20.04

%labels
    Author "Glen Dierickx"
    Version "0.1"
    Description "Apptainer container for the eNano pipeline"

%environment
    # Activate the conda environment on container start
    . /opt/conda/etc/profile.d/conda.sh
    conda activate eNano_env

%post
    # Update and install system dependencies (use gzip to include zcat)
    apt-get update && apt-get install -y \
        wget git build-essential curl gzip \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh

    # Run all conda and compilation steps inside a bash subshell
    bash -c "
        source /opt/conda/etc/profile.d/conda.sh

        # Fetch the environment YAML file from correct GitHub branch
        wget -O /opt/conda/eNano_env.yml 'https://raw.githubusercontent.com/MycoMatics/eNano/Apptainer/eNano_env.yml'

        # Create and activate the conda environment
        conda env create -n eNano_env -f /opt/conda/eNano_env.yml
        conda activate eNano_env

        # Install the compilers needed by mumu
        conda install -n eNano_env -y gcc_linux-64 gxx_linux-64

        # Install MUMU
        cd /opt/conda/envs/eNano_env
        git clone https://github.com/frederic-mahe/mumu.git
        cd mumu
        make CXX=/opt/conda/envs/eNano_env/bin/x86_64-conda-linux-gnu-g++
        make install prefix=/opt/conda/envs/eNano_env

        # Fetch eNano.sh
        cd /tmp
        wget -O eNano.sh 'https://raw.githubusercontent.com/MycoMatics/eNano/Apptainer/eNano.sh'
        cp eNano.sh /opt/conda/envs/eNano_env/bin/eNano
        chmod +x /opt/conda/envs/eNano_env/bin/eNano
    "

%runscript
    # This runs the eNano pipeline script when you run the container
    exec eNano "$@"
