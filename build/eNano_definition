Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Glen Dierickx"
    Version "0.1"
    Description "Apptainer container for the eNano pipeline without conda, pinned dependencies"

%environment
    export PATH=/usr/local/bin:/usr/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    # Update and install all system dependencies
    apt-get update && apt-get install -y \
        wget \
        gnupg \
        lsb-release \
        ca-certificates \
        software-properties-common \
        git \
        build-essential \
        curl \
        gzip \
        python3 \
        python3-pip \
        python3-setuptools \
        python3-wheel \
        cmake \
        autoconf \
        automake \
        libtool \
        pkg-config \
        make \
        unzip \
        && rm -rf /var/lib/apt/lists/*

    
    # Add LLVM repository for Clang 17
    wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh && ./llvm.sh 17

    # Install Clang 17
    apt-get update && apt-get install -y clang-17 lldb-17 lld-17 && rm -rf /var/lib/apt/lists/*

    # Update alternatives to set Clang 17 as default
    update-alternatives --install /usr/bin/clang clang /usr/bin/clang-17 100
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-17 100

    # Verify Clang installation
    clang --version
    clang++ --version

    # Upgrade pip
    python3 -m pip install --upgrade pip

    # Install Python dependencies
    python3 -m pip install "cutadapt>=2.8" "pandas>=2.2.2" "numpy>=2.1.1"

    # Install Porechop==0.2.4 from source
    cd /opt
    git clone --branch v0.2.4 https://github.com/rrwick/Porechop.git
    cd Porechop
    python3 -m pip install .
    cd /opt
    rm -rf Porechop

    # Install chopper>=0.9 directly from the released binary
    CHOPPER_VERSION="v0.9.0"
    wget "https://github.com/wdecoster/chopper/releases/download/${CHOPPER_VERSION}/chopper-linux.zip" -O /tmp/chopper-linux.zip
    unzip -j /tmp/chopper-linux.zip chopper -d /usr/local/bin/
    if [ -f /usr/local/bin/chopper ]; then
        chmod +x /usr/local/bin/chopper
    else
        echo "chopper binary not found!" >&2
        exit 1
    fi
    rm /tmp/chopper-linux.zip


    # Install vsearch>=2.21 from source (example v2.29.1)
    VSEARCH_VERSION="2.29.1"
    wget "https://github.com/torognes/vsearch/archive/v${VSEARCH_VERSION}.tar.gz" -O /tmp/vsearch-${VSEARCH_VERSION}.tar.gz
    tar xzf /tmp/vsearch-${VSEARCH_VERSION}.tar.gz -C /opt
    cd /opt/vsearch-${VSEARCH_VERSION}
    ./autogen.sh
    ./configure CFLAGS="-O3" CXXFLAGS="-O3"
    make ARFLAGS="cr"
    make install
    cd /opt
    rm -rf vsearch-${VSEARCH_VERSION} /tmp/vsearch-${VSEARCH_VERSION}.tar.gz

    # Install mumu (v1.0 tag) with Clang and C++20
    git clone https://github.com/frederic-mahe/mumu.git /opt/mumu
    cd /opt/mumu
    make CXX=clang++ CXXFLAGS="-std=c++2a"
    make install PREFIX=/usr/local
    cd /
    rm -rf /opt/mumu

    # Define eNano script URL and version
    ENANO_URL="https://raw.githubusercontent.com/MycoMatics/eNano/Apptainer_minimal/eNano.sh"
    
    # Fetch and install eNano.sh
    wget -O /usr/local/bin/eNano "${ENANO_URL}"
    chmod +x /usr/local/bin/eNano


%runscript
    exec eNano "$@"
